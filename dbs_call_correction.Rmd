---
title: "DBS call correction"
author: "Ellie Dunstone"
date: "2023-02-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, include=FALSE}
library(tidyverse)
library(deconstructSigs)
```

## Introduction

This script uses the trinucleotide frequencies present in your NanoSeq data (output by the NanoSeq pipeline) to calculate the dinucleotide frequencies present, and then use these values to correct your matrix of observed DBS counts (see "dnv_caller.Rmd") according to the dinucleotide frequency in your data. This effectively maps your observed calls onto the frequency that would be expected in a normal diploid human genome.

## Read in data

First, we want to read in our DBS mutation matrix. This script assumes that this is in the format generated by dnv_caller.Rmd ("MutationType" as column 1, followed by one column per sample of counts for each mutation class).

```{r set work dir}
work.dir <- "/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/"
```

```{r read in dbs matrix}
dbs_matrix <- read.table(paste0(work.dir,"data/dbs_mutation_matrix.tsv"))
```

We also need to read in and format the observed trinucleotide frequencies for our data, as calculated by the NanoSeq pipeline (ratio2genome files).

```{r read in ratio2genome files}
#list file names
files <- list.files(path = paste0(work.dir, "data/dbs_calling/ratio2genome/"), pattern = "*.tsv$")

#read in as tables
for (file in files) {
  temp <- read.table(paste0(work.dir, "data/dbs_calling/ratio2genome/", file), sep="\t", header = TRUE)
  temp <- cbind(trinuc = rownames(temp), data.frame(temp, row.names=NULL))
  assign(file, temp)
}

#add sample ID as column
tables <- c()

for (file in files) {
  new <- mutate(get(file), sampleID = paste0(strsplit(file, "_")[[1]][1], "_", strsplit(file, "_")[[1]][2]))
  assign(paste0("sampleID_", file), new)
  tables <- cbind(tables, paste0("sampleID_", file))
}

#concatenate tables
ratio2genome_table <- data.frame(matrix(ncol=ncol(new))) #init table
colnames(ratio2genome_table) <- colnames(new)

for (table in tables) {
  ratio2genome_table <- rbind(ratio2genome_table, get(table))
  print(table)
}

ratio2genome_table <- ratio2genome_table[-1,] #drop blank first row
```



Notes:
per sample file with the trinuc frequency in sample, and in genome
for each trinuc, keep only first two bases - sum over the entries for the third base
gives count for the trinucs - this is the observed
calculate freq for both
correct by normalising according to it
am looking for the trinuc ratio2genome file
can get actual counts in genome using deconstructsigs::trinuc_counts or soemthing? 