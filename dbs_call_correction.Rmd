---
title: "DBS call correction"
author: "Ellie Dunstone"
date: "2023-02-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, include=FALSE}
library(tidyverse)
library(deconstructSigs)
```

## Introduction

This script uses the trinucleotide frequencies present in your NanoSeq data (output by the NanoSeq pipeline) to calculate the dinucleotide frequencies present, and then use these values to correct your matrix of observed DBS counts (see "dnv_caller.Rmd") according to the dinucleotide frequency in your data. This effectively maps your observed calls onto the frequency that would be expected in a normal diploid human genome.

## Read in data

First, we want to read in our DBS mutation matrix. This script assumes that this is in the format generated by dnv_caller.Rmd ("MutationType" as column 1, followed by one column per sample of counts for each mutation class).

```{r set work dir}
work.dir <- "/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/"
```

```{r read in dbs matrix}
dbs_matrix <- read.table(paste0(work.dir,"data/dbs_mutation_matrix.tsv"))
```

We also need to read in and format the observed trinucleotide frequencies for our data, as calculated by the NanoSeq pipeline (ratio2genome files).

```{r read in ratio2genome files}
#list file names
files <- list.files(path = paste0(work.dir, "data/dbs_calling/ratio2genome/"), pattern = "*.tsv$")

#read in as tables
for (file in files) {
  temp <- read.table(paste0(work.dir, "data/dbs_calling/ratio2genome/", file), sep="\t", header = TRUE)
  temp <- cbind(trinuc = rownames(temp), data.frame(temp, row.names=NULL))
  assign(file, temp)
}

#add sample ID as column
tables <- c()

for (file in files) {
  new <- mutate(get(file), sampleID = paste0(strsplit(file, "_")[[1]][1], "_", strsplit(file, "_")[[1]][2]))
  assign(paste0("sampleID_", file), new)
  tables <- cbind(tables, paste0("sampleID_", file))
}

#concatenate tables
trinuc_ratio2genome_table <- data.frame(matrix(ncol=ncol(new))) #init table
colnames(trinuc_ratio2genome_table) <- colnames(new)

for (table in tables) {
  trinuc_ratio2genome_table <- rbind(trinuc_ratio2genome_table, get(table))
  print(table)
}

trinuc_ratio2genome_table <- trinuc_ratio2genome_table[-1,] #drop blank first row
```

Finally, we need the frequencies of trinucleotides present in the human genome. This can be obtained from the package 'deconstructSigs'.

```{r read in genome dinuc freqs}
genome_trinuc_freqs <- deconstructSigs::tri.counts.genome
genome_trinuc_freqs <- cbind(rownames(genome_trinuc_freqs), data.frame(genome_trinuc_freqs, row.names=NULL))
colnames(genome_trinuc_freqs) <- c("trinuc", "freq")
```


## Calculate dinucleotide frequencies

Now we have the data for our observed trinucleotide frequencies and those in the human genome, we can use this to calculate the dinucleotide frequencies. We can do this by summing the counts of trinucleotides, ignoring the 'third' base. For example, we can sum the counts for CTA, CTC, CTT and CTG to give the count for CT.

```{r calculate observed dinuc freq}
dinuc_ratio2genome_table <- trinuc_ratio2genome_table %>% select(trinuc, tri_bg, sampleID) %>% mutate(dinuc = substr(trinuc, 1, 2)) %>% group_by(sampleID, dinuc) %>% summarise(dinuc_count = sum(tri_bg)) 
```

```{r calculate genome dinuc freq}
genome_dinuc_freqs <- genome_trinuc_freqs %>% mutate(dinuc = substr(trinuc, 1, 2)) %>% group_by(dinuc) %>% summarise(genome_dinuc_count = sum(freq))
```

Using these data, we can now calculate the ratio between the observed dinucleotide proportions in our data and the proportions in the human genome.

```{r calculate dinuc ratio2genome}
dinuc_ratio2genome_table <- dinuc_ratio2genome_table %>% left_join(genome_dinuc_freqs) %>% mutate(obs_prop = dinuc_count/sum(dinuc_count)) %>% mutate(exp_prop = genome_dinuc_count/sum(genome_dinuc_count)) %>% mutate(dinuc_ratio2genome = obs_prop/exp_prop)
```

Need to now work out what to do next - how is this used to generate the 'burdens' file?



